<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Particle Animation</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
    }
  </style>
</head>
<body>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
  <script>
    let particles = [];
    let font;
    let targetPositions = [];
    let formingUsina = false;

    function preload() {
      // Load the uploaded font
      font = loadFont('AltRiveraBold.otf');
    }

    function setup() {
      createCanvas(windowWidth, windowHeight);
      textFont(font);
      textSize(200);
      textAlign(CENTER, CENTER);

      // Calculate target positions for the word "USINA"
      let points = font.textToPoints('USINA', width / 2 - 300, height / 2, 192, {
        sampleFactor: 0.2
      });

      for (let pt of points) {
        targetPositions.push(createVector(pt.x, pt.y));
      }

      for (let i = 0; i < targetPositions.length; i++) {
        particles.push(new Particle(random(width), random(height), targetPositions[i]));
      }

      // Listen for messages from the parent page
      window.addEventListener('message', (event) => {
        if (event.data === 'triggerUsina') {
          formingUsina = true;
        }
      });
    }

    function draw() {
      background('#76747B');
      for (let p of particles) {
        if (formingUsina) {
          p.setTargetToText();
        } else {
          p.setTargetToRandom();
        }
        p.update();
        p.display();
      }
    }

    class Particle {
      constructor(x, y, target) {
        this.pos = createVector(x, y);
        this.initialTarget = target;
        this.target = createVector(random(width), random(height));
        this.vel = p5.Vector.random2D();
        this.acc = createVector();
        this.maxSpeed = 5;
        this.maxForce = 0.3;
        this.noiseOffset = random(1000);
        this.shapeType = int(random(3)); // Randomly choose a shape type
        this.length = random(8, 20); // Length of the line segment
      }

      setTargetToText() {
        this.target = this.initialTarget;
      }

      setTargetToRandom() {
        this.target = createVector(random(width), random(height));
      }

      update() {
        // Move towards the target position
        let force = p5.Vector.sub(this.target, this.pos);
        let d = force.mag();
        let speed = this.maxSpeed;
        if (d < 100) {
          speed = map(d, 0, 100, 0, this.maxSpeed);
        }
        force.setMag(speed);
        force.sub(this.vel);
        force.limit(this.maxForce);
        this.applyForce(force);

        this.vel.add(this.acc);
        this.pos.add(this.vel);
        this.acc.mult(0);
      }

      applyForce(f) {
        this.acc.add(f);
      }

      display() {
        let noiseFactor = noise(this.noiseOffset) * 10;
        let x = this.pos.x;
        let y = this.pos.y;

        stroke(0);
        strokeWeight(2);

        switch (this.shapeType) {
          case 0:
            // Draw a straight line segment
            line(x, y, x + this.length * cos(noiseFactor), y + this.length * sin(noiseFactor));
            break;
          case 1:
            // Draw a 90-degree angle
            line(x, y, x + (this.length / 2) * cos(noiseFactor), y + (this.length / 2) * sin(noiseFactor));
            line(x + (this.length / 2) * cos(noiseFactor), y + (this.length / 2) * sin(noiseFactor), x + (this.length / 2) * cos(noiseFactor), y + this.length * sin(noiseFactor));
            break;
          case 2:
            // Draw a triangular wave
            line(x, y, x + (this.length / 4) * cos(noiseFactor), y + (this.length / 4) * sin(noiseFactor));
            line(x + (this.length / 4) * cos(noiseFactor), y + (this.length / 4) * sin(noiseFactor), x + (this.length / 2) * cos(noiseFactor), y);
            line(x + (this.length / 2) * cos(noiseFactor), y, x + this.length * cos(noiseFactor), y - (this.length / 4) * sin(noiseFactor));
            break;
        }

        this.noiseOffset += 0.018; // Increment noise offset for squiggly effect
      }
    }
  </script>
</body>
</html>
